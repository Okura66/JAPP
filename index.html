<!DOCTYPE html>
<html>
<head>
    <!-- Load the JotForm Custom Widget API -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
    <!-- Load intl-tel-input CSS for styling the phone input field -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <!-- Custom CSS for error message styling and phone input field -->
    <style>
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }
    </style>
</head>
<body>
    <div id="main">
        <h3 id="labelText">This is my first widget.</h3>
        <!-- The phone input field where users will enter their number -->
        <input type="tel" id="phoneInput">
        <!-- Placeholder for displaying error messages -->
        <div id="errorMsg" class="error-message"></div>
    </div>

<script type="text/javascript">
    JFCustomWidget.subscribe("ready", function(){
        var label = JFCustomWidget.getWidgetSetting('WidgetLabel');
        document.getElementById('labelText').innerHTML = label;
        var phoneInput = document.querySelector("#phoneInput");
        var errorMsg = document.querySelector("#errorMsg");

        var iti = window.intlTelInput(phoneInput, {
            loadUtilsOnInit: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
            initialCountry: "fr",
            useFullscreenPopup: false,
            countrySearch: true,
            fixDropdownWidth: true,
            strictMode: true,
            validationNumberType: "MOBILE",
            dropdownContainer: document.body // Append the country dropdown to the body
        });

        function resetError() {
            errorMsg.innerHTML = "";
        }

        // Add event listeners to reset error message on input change or focus
        phoneInput.addEventListener('change', resetError);
        phoneInput.addEventListener('keyup', resetError);
        phoneInput.addEventListener('focus', resetError);

        // Add event listener to resize iframe when the dropdown is opened
        phoneInput.addEventListener('open:countrydropdown', function() {
            JFCustomWidget.requestFrameResize({ height: 320 }); // Adjust height as needed
        });

        phoneInput.addEventListener('close:countrydropdown', function() {
            JFCustomWidget.requestFrameResize({ height: 140 }); // Reset height to original or desired value
        });
    });

    //subscribe to submit event
    JFCustomWidget.subscribe("submit", function(){
        //prepare your data
        var data = {};
        if (iti.isValidNumber()) {
            try {
                var fullNumber = iti.getNumber();
                if (fullNumber) {
                    data.valid = true;
                    data.value = fullNumber; // Retrieve the full phone number with the country code
                } else {
                    console.error("Full phone number is null.");
                    data.valid = false;
                    data.value = "";
                }
            } catch (error) {
                console.error("Error retrieving phone number:", error);
                data.valid = false;
                data.value = "";
            }
        } else {
            console.log("Phone number is not valid.");
            data.valid = false;
            data.value = "";
        }
        
        JFCustomWidget.sendResult(data);      
    });   
</script>
</body>
</html>
