<!DOCTYPE html>
<html>

<head>
    <!-- Load the JotForm Custom Widget API -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>

    <!-- Load intl-tel-input CSS for styling the phone input field -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <!-- Custom CSS for error message styling and phone input field -->
    <style>
        /* Style for error messages */
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Style for the phone input field */
        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }

        /* Style for the search input in the country dropdown */
        .iti__search-input {
            width: 100%;
            border-width: 0;
            border-radius: 3px;
            height: 35px;
        }
    </style>
</head>

<body>
    <div id="main">
        <h3 id="labelText">Votre numéro</h3>
        <!-- The phone input field where users will enter their number -->
        <input type="tel" id="phoneInput">
        <!-- Placeholder for displaying error messages -->
        <div id="errorMsg" class="error-message"></div>
        <p id="versionText">Version 0.1.122</p>
    </div>

    <script type="text/javascript">
        // Subscribe to the "ready" event to initialize the widget
        JFCustomWidget.subscribe("ready", function () {
            console.log("Ready event triggered.");
        
            // Get the widget label setting and update the label text
            var label = JFCustomWidget.getWidgetSetting('WidgetLabel');
            document.getElementById('labelText').innerHTML = label;
        
            // Get initial settings for the phone input
            var countryLanguage = JFCustomWidget.getWidgetSetting('CountryLanguage') || "fr";
            var initialCountry = JFCustomWidget.getWidgetSetting('InitialCountry') || "fr";
            var countrySearch = JFCustomWidget.getWidgetSetting('CountrySearch') || "true";
            var customErrorMessage = JFCustomWidget.getWidgetSetting('ErrorMessage') || "Veuillez entrer un numéro de téléphone valide.";
        
            // Function to dynamically load the i18n script based on the initial country
            function loadI18nModule(countryCode) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/${countryCode}/index.js`;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`Failed to load i18n module for ${countryCode}`));
                    document.head.appendChild(script);
                });
            }

            // Dynamically load the i18n module for the selected country
            loadI18nModule(countryLanguage)
                .then(() => {
                    console.log(`i18n module for ${initialCountry} loaded successfully.`);
        
                    // Select the phone input and error message elements
                    var phoneInput = document.querySelector("#phoneInput");
                    var errorMsg = document.querySelector("#errorMsg");
        
                    // Initialize the intl-tel-input plugin with settings
                    var iti = window.intlTelInput(phoneInput, {
                        loadUtilsOnInit: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
                        initialCountry: initialCountry,
                        useFullscreenPopup: false,
                        countrySearch: countrySearch,
                        fixDropdownWidth: true,
                        strictMode: true,
                        validationNumberType: "MOBILE",
                        i18n: countryLanguage,
                        dropdownContainer: document.body // Append the country dropdown to the body
                    });
        
                    // Add the rest of your event listeners and logic here
                    function resetError() {
                        errorMsg.innerHTML = "";
                    }
        
                    phoneInput.addEventListener('change', resetError);
                    phoneInput.addEventListener('keyup', resetError);
                    phoneInput.addEventListener('focus', resetError);
        
                    // Add event listener to resize iframe when the dropdown is opened
                    phoneInput.addEventListener('open:countrydropdown', function () {
                        JFCustomWidget.requestFrameResize({ height: 330 }); // Adjust height as needed
                    });
        
                    // Add event listener to resize iframe when the dropdown is closed
                    phoneInput.addEventListener('close:countrydropdown', function () {
                        JFCustomWidget.requestFrameResize({ height: 140 }); // Reset height to original or desired value
                    });
        
        
                    // Send data when the input is valid
                    phoneInput.addEventListener('input', function () {
                        if (iti.isValidNumber()) {
                            try {
                                var fullNumber = iti.getNumber();
                                if (fullNumber) {
                                    JFCustomWidget.sendData({
                                        valid: true,
                                        value: fullNumber
                                    });
                                    console.log("Data sent:", fullNumber);
                                }
                            } catch (error) {
                                console.error("Error retrieving full phone number:", error);
                            }
                        }
                    });
        
                    // Validation logic on submit
                    JFCustomWidget.subscribe("submit", function () {
                        console.log("Submit event triggered.");
                        var msg = { valid: true, value: "" };
        
                        if (iti.isValidNumber()) {
                            try {
                                var fullNumber = iti.getNumber();
                                if (fullNumber) {
                                    msg.value = fullNumber;
                                } else {
                                    console.error("Full phone number is null.");
                                }
                            } catch (error) {
                                console.error("Error retrieving full phone number:", error);
                            }
                        } else {
                            errorMsg.innerHTML = customErrorMessage;
                            msg.valid = false;
                        }
        
                        JFCustomWidget.sendSubmit(msg);
                    });
                })
                .catch(error => {
                    console.error("Error loading i18n module:", error);
                });
        });
    </script>
</body>

</html>
