<!DOCTYPE html>
<html>
<head>
    <!-- Charger l'API du widget personnalisé JotForm -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
    <!-- Charger le CSS de intl-tel-input pour le style du champ de saisie téléphonique -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <!-- CSS personnalisé pour le style du message d'erreur et du champ de saisie téléphonique -->
    <style>
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }
    </style>
</head>
<body>
    <div id="main">
        <h3 id="labelText">Ceci est mon premier widget.</h3>
        <!-- Champ de saisie téléphonique où les utilisateurs entreront leur numéro -->
        <input type="tel" id="phoneInput">
        <!-- Espace réservé pour afficher les messages d'erreur -->
        <div id="errorMsg" class="error-message"></div>
    </div>

<script type="text/javascript">
    JFCustomWidget.subscribe("ready", function(){
        var label = JFCustomWidget.getWidgetSetting('WidgetLabel');
        document.getElementById('labelText').innerHTML = label;
        var phoneInput = document.querySelector("#phoneInput");
        var errorMsg = document.querySelector("#errorMsg");

        var iti = window.intlTelInput(phoneInput, {
            loadUtilsOnInit: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
            initialCountry: "fr",
            useFullscreenPopup: false,
            countrySearch: true,
            fixDropdownWidth: true,
            strictMode: true,
            validationNumberType: "MOBILE",
            dropdownContainer: document.body // Ajouter le menu déroulant des pays au corps du document
        });

        // Fonction pour afficher le message d'erreur
        function showError(message) {
            errorMsg.innerHTML = message;
        }

        // Fonction pour valider le numéro de téléphone
        function validatePhoneNumber() {
            if (iti.isValidNumber()) {
                errorMsg.innerHTML = "";
                return true;
            } else {
                showError("Veuillez entrer un numéro de téléphone valide.");
                return false;
            }
        }

        // Ajouter un écouteur d'événement pour la validation en temps réel
        phoneInput.addEventListener('input', function() {
            validatePhoneNumber();
        });

        // Ajouter un écouteur d'événement pour redimensionner l'iframe lorsque le menu déroulant est ouvert
        phoneInput.addEventListener('open:countrydropdown', function() {
            JFCustomWidget.requestFrameResize({ height: 320 }); // Ajuster la hauteur si nécessaire
        });

        phoneInput.addEventListener('close:countrydropdown', function() {
            JFCustomWidget.requestFrameResize({ height: 140 }); // Réinitialiser la hauteur à la valeur d'origine ou souhaitée
        });

        // S'abonner à l'événement "submit" pour valider et envoyer les données lors de la soumission du formulaire
        JFCustomWidget.subscribe("submit", function(){
            // Valider le numéro de téléphone avant la soumission
            if (validatePhoneNumber()) {
                // Si valide, créer un message avec les attributs requis
                var msg = {
                    valid: true, // Définir valid à true pour passer la validation requise de JotForm
                    value: iti.getNumber() // Récupérer le numéro de téléphone complet avec l'indicatif pays
                };
                // Envoyer le numéro de téléphone valide à JotForm
                JFCustomWidget.sendSubmit(msg);
            } else {
                // Si le numéro de téléphone est invalide, empêcher la soumission du formulaire
                JFCustomWidget.sendSubmit({ valid: false });
            }
        });
    });
</script>
</body>
</html>
