<!DOCTYPE html>
<html>
<head>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <style>
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }

        .iti__search-input {
            width: 100%;
            border-width: 0;
            border-radius: 3px;
            height: 35px;
        }
    </style>
</head>

<body>
    <div id="main">
        <h3 id="labelText">Numéro de téléphone</h3>
        <input type="tel" id="phoneInput">
        <div id="errorMsg" class="error-message"></div>
        <p id="versionText">Version 0.1.0</p>
    </div>

    <script type="text/javascript">
        // Fonction pour charger les traductions
        async function loadTranslations() {
            try {
                const [countriesResponse, interfaceResponse] = await Promise.all([
                    fetch('https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/fr/countries.js'),
                    fetch('https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/fr/interface.js')
                ]);

                const countriesText = await countriesResponse.text();
                const interfaceText = await interfaceResponse.text();

                // Extraire le contenu des objets des fichiers JS
                const countriesMatch = countriesText.match(/export default ({[\s\S]*});/);
                const interfaceMatch = interfaceText.match(/export default ({[\s\S]*});/);

                if (!countriesMatch || !interfaceMatch) {
                    throw new Error("Format de traduction inattendu");
                }

                // Évaluer les objets de traduction de manière sécurisée
                const countryTranslations = Function(`return ${countriesMatch[1]}`)();
                const interfaceTranslations = Function(`return ${interfaceMatch[1]}`)();

                // Combiner les traductions
                return { ...countryTranslations, ...interfaceTranslations };
            } catch (error) {
                console.error("Erreur lors du chargement des traductions:", error);
                // Retourner un objet de traduction minimal en cas d'erreur
                return {
                    selectedCountryAriaLabel: "Pays sélectionné",
                    searchPlaceholder: "Rechercher un pays",
                    // ... autres traductions par défaut si nécessaire
                };
            }
        }

        // Initialiser le widget une fois les traductions chargées
        async function initializeWidget() {
            const translations = await loadTranslations();
            
            JFCustomWidget.subscribe("ready", function () {
                var label = JFCustomWidget.getWidgetSetting('WidgetLabel');
                document.getElementById('labelText').innerHTML = label;

                var phoneInput = document.querySelector("#phoneInput");
                var errorMsg = document.querySelector("#errorMsg");

                var initialCountry = JFCustomWidget.getWidgetSetting('InitialCountry') || "fr";
                var countrySearch = JFCustomWidget.getWidgetSetting('CountrySearch') || "true";
                var customErrorMessage = JFCustomWidget.getWidgetSetting('ErrorMessage') || "Veuillez entrer un numéro de téléphone valide.";

                var iti = window.intlTelInput(phoneInput, {
                    loadUtilsOnInit: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
                    initialCountry: initialCountry,
                    useFullscreenPopup: false,
                    countrySearch: countrySearch,
                    fixDropdownWidth: true,
                    strictMode: true,
                    i18n: translations,  // Utilisation des traductions chargées
                    validationNumberType: "MOBILE",
                    dropdownContainer: document.body
                });

                function resetError() {
                    errorMsg.innerHTML = "";
                }

                phoneInput.addEventListener('change', resetError);
                phoneInput.addEventListener('keyup', resetError);
                phoneInput.addEventListener('focus', resetError);

                phoneInput.addEventListener('open:countrydropdown', function () {
                    JFCustomWidget.requestFrameResize({ height: 330 });
                });

                phoneInput.addEventListener('close:countrydropdown', function () {
                    JFCustomWidget.requestFrameResize({ height: 140 });
                });

                phoneInput.addEventListener('input', function () {
                    if (iti.isValidNumber()) {
                        try {
                            var fullNumber = iti.getNumber();
                            if (fullNumber) {
                                JFCustomWidget.sendData({
                                    valid: true,
                                    value: fullNumber
                                });
                            }
                        } catch (error) {
                            console.error("Error retrieving full phone number:", error);
                        }
                    }
                });

                JFCustomWidget.subscribe("submit", function () {
                    var msg = { valid: true, value: "" };

                    if (iti.isValidNumber()) {
                        try {
                            var fullNumber = iti.getNumber();
                            if (fullNumber) {
                                msg.value = fullNumber;
                            }
                        } catch (error) {
                            console.error("Error retrieving full phone number:", error);
                        }
                    } else {
                        errorMsg.innerHTML = customErrorMessage;
                        msg.valid = false;
                    }

                    JFCustomWidget.sendSubmit(msg);
                });
            });
        }

        // Démarrer l'initialisation
        initializeWidget();
    </script>
</body>
</html>