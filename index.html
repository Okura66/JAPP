<!DOCTYPE html>
<html>
<head>
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <style>
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }

        .iti__search-input {
            width: 100%;
            border-width: 0;
            border-radius: 3px;
            height: 35px;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div id="main" class="loading">
        <h3 id="labelText">Numéro de téléphone</h3>
        <input type="tel" id="phoneInput">
        <div id="errorMsg" class="error-message"></div>
        <p id="versionText">Version 0.1.0</p>
    </div>

    <script type="text/javascript">
        // Fonction pour charger les traductions
        async function loadTranslations() {
            try {
                const [countriesResponse, interfaceResponse] = await Promise.all([
                    fetch('https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/fr/countries.js'),
                    fetch('https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/fr/interface.js')
                ]);

                console.log('Countries response:', countriesResponse);
                console.log('Interface response:', interfaceResponse);

                if (!countriesResponse.ok || !interfaceResponse.ok) {
                    throw new Error('Network response was not ok');
                }

                const countriesText = await countriesResponse.text();
                const interfaceText = await interfaceResponse.text();

                console.log('Countries text:', countriesText);
                console.log('Interface text:', interfaceText);

                // Extraction des objets de traduction
                const countryTranslations = JSON.parse(countriesText.match(/const countryTranslations = ({[\s\S]*?});/)[1]);
                const interfaceTranslations = JSON.parse(interfaceText.match(/const interfaceTranslations = ({[\s\S]*?});/)[1]);

                console.log('Country translations:', countryTranslations);
                console.log('Interface translations:', interfaceTranslations);

                return { ...countryTranslations, ...interfaceTranslations };
            } catch (error) {
                console.error('Failed to load translations:', error);
                // En cas d'erreur, on retourne un objet minimal de traduction
                return {
                    fr: "France",
                    selectedCountryAriaLabel: "Pays sélectionné",
                    searchPlaceholder: "Recherche",
                    // ... autres traductions minimales nécessaires
                };
            }
        }

        // Fonction d'initialisation du widget
        async function initializeWidget() {
            try {
                const translations = await loadTranslations();
                document.getElementById('main').classList.remove('loading');

                JFCustomWidget.subscribe("ready", function () {
                    var label = JFCustomWidget.getWidgetSetting('WidgetLabel');
                    document.getElementById('labelText').innerHTML = label;

                    var phoneInput = document.querySelector("#phoneInput");
                    var errorMsg = document.querySelector("#errorMsg");

                    var initialCountry = JFCustomWidget.getWidgetSetting('InitialCountry') || "fr";
                    var countrySearch = JFCustomWidget.getWidgetSetting('CountrySearch') || "true";
                    var customErrorMessage = JFCustomWidget.getWidgetSetting('ErrorMessage') || "Veuillez entrer un numéro de téléphone valide.";

                    var iti = window.intlTelInput(phoneInput, {
                        loadUtilsOnInit: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
                        initialCountry: initialCountry,
                        useFullscreenPopup: false,
                        countrySearch: countrySearch,
                        fixDropdownWidth: true,
                        strictMode: true,
                        i18n: translations,
                        validationNumberType: "MOBILE",
                        dropdownContainer: document.body
                    });

                    function resetError() {
                        errorMsg.innerHTML = "";
                    }

                    phoneInput.addEventListener('change', resetError);
                    phoneInput.addEventListener('keyup', resetError);
                    phoneInput.addEventListener('focus', resetError);

                    phoneInput.addEventListener('open:countrydropdown', function () {
                        JFCustomWidget.requestFrameResize({ height: 330 });
                    });

                    phoneInput.addEventListener('close:countrydropdown', function () {
                        JFCustomWidget.requestFrameResize({ height: 140 });
                    });

                    phoneInput.addEventListener('input', function () {
                        if (iti.isValidNumber()) {
                            try {
                                var fullNumber = iti.getNumber();
                                if (fullNumber) {
                                    JFCustomWidget.sendData({
                                        valid: true,
                                        value: fullNumber
                                    });
                                }
                            } catch (error) {
                                console.error("Error retrieving full phone number:", error);
                            }
                        }
                    });

                    JFCustomWidget.subscribe("submit", function () {
                        var msg = { valid: true, value: "" };

                        if (iti.isValidNumber()) {
                            try {
                                var fullNumber = iti.getNumber();
                                if (fullNumber) {
                                    msg.value = fullNumber;
                                }
                            } catch (error) {
                                console.error("Error retrieving full phone number:", error);
                            }
                        } else {
                            errorMsg.innerHTML = customErrorMessage;
                            msg.valid = false;
                        }

                        JFCustomWidget.sendSubmit(msg);
                    });
                });
            } catch (error) {
                console.error('Failed to initialize widget:', error);
                document.getElementById('main').classList.remove('loading');
                document.getElementById('errorMsg').innerHTML = "Une erreur s'est produite lors de l'initialisation du widget.";
            }
        }

        // Démarrage de l'initialisation
        initializeWidget();
    </script>
</body>
</html>