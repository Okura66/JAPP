<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Load the JotForm Custom Widget API -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

    <!-- Load intl-tel-input CSS for styling the phone input field -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/intlTelInput.min.js"></script>

    <!-- Custom CSS for error message styling and phone input field -->
    <style>
        /* Style for error messages */
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Style for the phone input field */
        #phoneInput {
            width: 100%;
            height: 40px;
            border: 1px solid #d3d3d3;
        }

        /* Style for the search input in the country dropdown */
        .iti__search-input {
            width: 100%;
            border-width: 0;
            border-radius: 3px;
            height: 35px;
        }
    </style>
</head>

<body>
    <div id="main">
        <h3 id="labelText">Numéro de téléphone</h3>
        <!-- The phone input field where users will enter their number -->
        <input type="tel" id="phoneInput">
        <!-- Placeholder for displaying error messages -->
        <div id="errorMsg" class="error-message"></div>
        <p id="versionText">Version 0.1.2</p>
    </div>

    <script type="text/javascript">
        // JotForm Custom Widget ready event
        JFCustomWidget.subscribe("ready", function () {
            console.log("Widget ready event triggered.");

            // Function to dynamically load a script
            function loadScript(url, callback) {
                var script = document.createElement("script");
                script.type = "text/javascript";
                script.src = url;
                script.onload = callback;
                document.head.appendChild(script);
            }

            // Add events to the phone input field
            function addPhoneInputEvents(phoneInput, errorMsg, iti) {
                function resetError() {
                    errorMsg.innerHTML = "";
                }

                phoneInput.addEventListener('change', resetError);
                phoneInput.addEventListener('keyup', resetError);
                phoneInput.addEventListener('focus', resetError);

                phoneInput.addEventListener('input', function () {
                    if (iti.isValidNumber()) {
                        try {
                            var fullNumber = iti.getNumber();
                            if (fullNumber) {
                                JFCustomWidget.sendData({ valid: true, value: fullNumber });
                                console.log("Data sent:", fullNumber);
                            }
                        } catch (error) {
                            console.error("Error retrieving full phone number:", error);
                        }
                    }
                });
            }

            // Get widget settings
            var label = JFCustomWidget.getWidgetSetting('WidgetLabel') || "Numéro de téléphone";
            document.getElementById('labelText').innerHTML = label;

            var initialCountry = JFCustomWidget.getWidgetSetting('InitialCountry') || "fr";
            var countrySearch = JFCustomWidget.getWidgetSetting('CountrySearch') || true;
            var customErrorMessage = JFCustomWidget.getWidgetSetting('ErrorMessage') || "Veuillez entrer un numéro de téléphone valide.";
            var languageCode = JFCustomWidget.getWidgetSetting('Language') || 'fr';

            // Load translations dynamically based on the language setting
            loadScript(`https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/${languageCode}/countries.js`, function () {
                loadScript(`https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/i18n/${languageCode}/interface.js`, function () {
                    if (typeof countryTranslations !== 'undefined' && typeof interfaceTranslations !== 'undefined') {
                        const i18n = { ...countryTranslations, ...interfaceTranslations };

                        var phoneInput = document.querySelector("#phoneInput");
                        var errorMsg = document.querySelector("#errorMsg");

                        // Initialize intl-tel-input
                        var iti = window.intlTelInput(phoneInput, {
                            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@24.7.0/build/js/utils.js",
                            initialCountry: initialCountry,
                            useFullscreenPopup: false,
                            countrySearch: countrySearch,
                            fixDropdownWidth: true,
                            strictMode: true,
                            i18n: i18n,
                            validationNumberType: "MOBILE",
                            dropdownContainer: document.body
                        });

                        // Add events to the phone input
                        addPhoneInputEvents(phoneInput, errorMsg, iti);

                        // JotForm submit event
                        JFCustomWidget.subscribe("submit", function () {
                            var msg = { valid: true, value: "" };

                            if (iti.isValidNumber()) {
                                try {
                                    var fullNumber = iti.getNumber();
                                    if (fullNumber) msg.value = fullNumber;
                                } catch (error) {
                                    console.error("Error retrieving full phone number:", error);
                                }
                            } else {
                                errorMsg.innerHTML = customErrorMessage;
                                msg.valid = false;
                            }

                            JFCustomWidget.sendSubmit(msg);
                        });
                    } else {
                        console.error("Erreur lors du chargement des traductions.");
                    }
                });
            });
        });
    </script>
</body>

</html>
